{
  "name": "ä¸€æ¬¡æ€§æ”¶é›†20ä¸ªä¸´åºŠè¯•éªŒç»“æœ",
  "nodes": [
    {
      "parameters": {},
      "name": "æ‰‹åŠ¨è§¦å‘æ”¶é›†",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://clinicaltrials.gov/api/query/study_fields",
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "expr",
              "value": "AREA[StudyType]EXACT[\"Interventional\"] AND AREA[Phase]PHASE3 AND AREA[OverallStatus]EXACT[\"Completed\"] AND AREA[HasResults]EXACT[\"true\"]"
            },
            {
              "name": "fields", 
              "value": "NCTId,BriefTitle,Condition,InterventionName,PrimaryOutcomeMeasure,SecondaryOutcomeMeasure,CompletionDate,EnrollmentCount,HasResults,ResultsFirstPostDate"
            },
            {
              "name": "min_rnk",
              "value": "1"
            },
            {
              "name": "max_rnk", 
              "value": "50"
            },
            {
              "name": "fmt",
              "value": "json"
            }
          ]
        }
      },
      "name": "æœç´¢å·²å®Œæˆè¯•éªŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "functionCode": "// ç­›é€‰å’Œæ¸…ç†å·²å®Œæˆçš„ä¸´åºŠè¯•éªŒæ•°æ®\nconst items = $input.all();\nconst processedData = [];\n\nfor (const item of items) {\n  const studies = item.json.StudyFieldsResponse?.StudyFields || [];\n  \n  for (const study of studies) {\n    // åªä¿ç•™æœ‰ç»“æœçš„å·²å®Œæˆè¯•éªŒ\n    if (study.HasResults && study.HasResults[0] === 'true') {\n      const processedStudy = {\n        nctId: study.NCTId?.[0] || '',\n        title: study.BriefTitle?.[0] || '',\n        condition: study.Condition?.join('; ') || '',\n        intervention: study.InterventionName?.join('; ') || '',\n        primaryOutcome: study.PrimaryOutcomeMeasure?.[0] || '',\n        secondaryOutcome: study.SecondaryOutcomeMeasure?.join('; ') || '',\n        completionDate: study.CompletionDate?.[0] || '',\n        enrollmentCount: parseInt(study.EnrollmentCount?.[0]) || 0,\n        resultsPostedDate: study.ResultsFirstPostDate?.[0] || '',\n        // ç”Ÿæˆç»“æœé¡µé¢é“¾æ¥\n        resultsUrl: `https://clinicaltrials.gov/study/${study.NCTId?.[0]}/results`,\n        // æ•°æ®è´¨é‡è¯„åˆ†\n        qualityScore: {\n          hasResults: !!study.HasResults?.[0],\n          hasPrimary: !!study.PrimaryOutcomeMeasure?.[0],\n          hasEnrollment: !!study.EnrollmentCount?.[0],\n          isLargeTrial: parseInt(study.EnrollmentCount?.[0] || 0) > 100\n        }\n      };\n      \n      processedData.push({ json: processedStudy });\n    }\n  }\n}\n\n// æŒ‰å…¥ç»„äººæ•°æ’åºï¼Œä¼˜å…ˆé€‰æ‹©å¤§æ ·æœ¬è¯•éªŒ\nprocessedData.sort((a, b) => b.json.enrollmentCount - a.json.enrollmentCount);\n\n// åªå–å‰20ä¸ª\nreturn processedData.slice(0, 20);"
      },
      "name": "ç­›é€‰å‰20ä¸ªä¼˜è´¨è¯•éªŒ",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://clinicaltrials.gov/api/query/full_studies",
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "expr",
              "value": "AREA[NCTId]={{$json.nctId}}"
            },
            {
              "name": "fmt",
              "value": "json"
            }
          ]
        }
      },
      "name": "è·å–è¯¦ç»†ç»“æœæ•°æ®",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "functionCode": "// æå–è¯¦ç»†çš„ç»“æœæ•°æ®\nconst items = $input.all();\nconst detailedResults = [];\n\nfor (const item of items) {\n  const study = item.json.FullStudiesResponse?.FullStudies?.[0]?.Study;\n  \n  if (study) {\n    const resultsSection = study.ResultsSection;\n    const protocolSection = study.ProtocolSection;\n    \n    const detailedResult = {\n      // åŸºæœ¬ä¿¡æ¯\n      nctId: protocolSection?.IdentificationModule?.NCTId || '',\n      title: protocolSection?.IdentificationModule?.BriefTitle || '',\n      \n      // ç ”ç©¶è®¾è®¡\n      studyType: protocolSection?.DesignModule?.StudyType || '',\n      phase: protocolSection?.DesignModule?.PhaseList?.Phase?.join(', ') || '',\n      allocation: protocolSection?.DesignModule?.DesignInfo?.DesignAllocation || '',\n      masking: protocolSection?.DesignModule?.DesignInfo?.DesignMasking || '',\n      \n      // å‚ä¸è€…ä¿¡æ¯\n      enrollmentCount: protocolSection?.DesignModule?.EnrollmentInfo?.EnrollmentCount || 0,\n      eligibilityCriteria: protocolSection?.EligibilityModule?.EligibilityCriteria || '',\n      \n      // å¹²é¢„æªæ–½\n      interventions: protocolSection?.ArmsInterventionsModule?.InterventionList?.Intervention?.map(i => ({\n        type: i.InterventionType,\n        name: i.InterventionName,\n        description: i.InterventionDescription\n      })) || [],\n      \n      // ä¸»è¦ç»“æœ\n      primaryOutcomes: protocolSection?.OutcomesModule?.PrimaryOutcomeList?.PrimaryOutcome?.map(o => ({\n        measure: o.PrimaryOutcomeMeasure,\n        timeFrame: o.PrimaryOutcomeTimeFrame,\n        description: o.PrimaryOutcomeDescription\n      })) || [],\n      \n      // ç»“æœæ•°æ® (è¿™æ˜¯å…³é”®éƒ¨åˆ†)\n      results: {\n        participantFlow: resultsSection?.ParticipantFlowModule,\n        baselineCharacteristics: resultsSection?.BaselineCharacteristicsModule,\n        outcomeData: resultsSection?.OutcomeMeasuresModule?.OutcomeMeasureList?.OutcomeMeasure?.map(outcome => ({\n          title: outcome.OutcomeMeasureTitle,\n          description: outcome.OutcomeMeasureDescription,\n          timeFrame: outcome.OutcomeMeasureTimeFrame,\n          type: outcome.OutcomeMeasureType,\n          // å…·ä½“æ•°å€¼ç»“æœ\n          results: outcome.OutcomeMeasureAnalysisList?.OutcomeMeasureAnalysis?.map(analysis => ({\n            groupDescription: analysis.OutcomeMeasureAnalysisGroupDescription,\n            statisticalMethod: analysis.OutcomeMeasureAnalysisStatisticalMethod,\n            pValue: analysis.OutcomeMeasureAnalysisPValue,\n            statisticalComment: analysis.OutcomeMeasureAnalysisStatisticalComment\n          })) || []\n        })) || [],\n        adverseEvents: resultsSection?.AdverseEventsModule\n      },\n      \n      // å…ƒæ•°æ®\n      lastUpdateDate: protocolSection?.StatusModule?.LastUpdatePostDate,\n      resultsFirstPosted: protocolSection?.StatusModule?.ResultsFirstPostDate,\n      collectedAt: new Date().toISOString()\n    };\n    \n    detailedResults.push({ json: detailedResult });\n  }\n}\n\nreturn detailedResults;"
      },
      "name": "æå–å…³é”®ç»“æœæ•°æ®",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": "your-google-sheet-id",
        "sheetName": "ä¸´åºŠè¯•éªŒç»“æœæ•°æ®",
        "columns": {
          "mappingMode": "defineBelow",
          "values": {
            "NCT ID": "={{$json.nctId}}",
            "ç ”ç©¶æ ‡é¢˜": "={{$json.title}}",
            "ç ”ç©¶ç±»å‹": "={{$json.studyType}}",
            "è¯•éªŒåˆ†æœŸ": "={{$json.phase}}",
            "å…¥ç»„äººæ•°": "={{$json.enrollmentCount}}",
            "å¹²é¢„æªæ–½": "={{JSON.stringify($json.interventions)}}",
            "ä¸»è¦ç»ˆç‚¹": "={{JSON.stringify($json.primaryOutcomes)}}",
            "ç»“æœæ•°æ®": "={{JSON.stringify($json.results.outcomeData)}}",
            "æ”¶é›†æ—¶é—´": "={{$json.collectedAt}}",
            "ç»“æœé“¾æ¥": "=https://clinicaltrials.gov/study/{{$json.nctId}}/results"
          }
        }
      },
      "name": "ä¿å­˜è¯¦ç»†ç»“æœ",
      "type": "n8n-nodes-base.googleSheets", 
      "typeVersion": 3,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "toEmail": "your-email@example.com",
        "subject": "âœ… å·²å®Œæˆï¼š20ä¸ªä¸´åºŠè¯•éªŒç»“æœæ•°æ®æ”¶é›†",
        "emailFormat": "html",
        "message": "=<h2>ğŸ¯ ä¸´åºŠè¯•éªŒç»“æœæ”¶é›†å®Œæˆï¼</h2>\n\n<h3>ğŸ“Š æ”¶é›†æ‘˜è¦:</h3>\n<ul>\n<li><strong>æ€»æ•°:</strong> 20ä¸ªå·²å®Œæˆçš„IIIæœŸè¯•éªŒ</li>\n<li><strong>æ•°æ®ç±»å‹:</strong> åŒ…å«è¯¦ç»†ç»“æœæ•°æ®</li>\n<li><strong>è´¨é‡æ ‡å‡†:</strong> æœ‰å‘å¸ƒç»“æœã€æœ‰ä¸»è¦ç»ˆç‚¹</li>\n</ul>\n\n<h3>ğŸ”¬ ç¤ºä¾‹è¯•éªŒ:</h3>\n<table border=\"1\" style=\"border-collapse: collapse;\">\n<tr><th>NCT ID</th><th>æ ‡é¢˜</th><th>å…¥ç»„äººæ•°</th></tr>\n{{#each $json}}\n<tr>\n<td>{{this.nctId}}</td>\n<td>{{this.title}}</td>\n<td>{{this.enrollmentCount}}</td>\n</tr>\n{{/each}}\n</table>\n\n<h3>ğŸ¯ ä¸‹ä¸€æ­¥:</h3>\n<ol>\n<li>æŸ¥çœ‹Googleè¡¨æ ¼ä¸­çš„è¯¦ç»†æ•°æ®</li>\n<li>å¼€å§‹æ„å»ºLangChainè§£æpipeline (Week 3-5)</li>\n<li>æå–æ²»ç–—ç»„ã€å“åº”ç‡ã€på€¼ç­‰å…³é”®ä¿¡æ¯</li>\n</ol>\n\n<p><em>æ•°æ®æ”¶é›†å®Œæˆäº: {{new Date().toLocaleString()}}</em></p>"
      },
      "name": "å‘é€å®Œæˆé€šçŸ¥",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [1560, 300]
    }
  ],
  "connections": {
    "æ‰‹åŠ¨è§¦å‘æ”¶é›†": {
      "main": [
        [
          {
            "node": "æœç´¢å·²å®Œæˆè¯•éªŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœç´¢å·²å®Œæˆè¯•éªŒ": {
      "main": [
        [
          {
            "node": "ç­›é€‰å‰20ä¸ªä¼˜è´¨è¯•éªŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç­›é€‰å‰20ä¸ªä¼˜è´¨è¯•éªŒ": {
      "main": [
        [
          {
            "node": "è·å–è¯¦ç»†ç»“æœæ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–è¯¦ç»†ç»“æœæ•°æ®": {
      "main": [
        [
          {
            "node": "æå–å…³é”®ç»“æœæ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–å…³é”®ç»“æœæ•°æ®": {
      "main": [
        [
          {
            "node": "ä¿å­˜è¯¦ç»†ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¿å­˜è¯¦ç»†ç»“æœ": {
      "main": [
        [
          {
            "node": "å‘é€å®Œæˆé€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "one-time-trial-collector"
} 