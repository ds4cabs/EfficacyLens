{
  "name": "ä¸´åºŠè¯•éªŒæ•°æ®æ”¶é›†å™¨",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * 1"
            }
          ]
        }
      },
      "name": "æ¯å‘¨ä¸€æ”¶é›†æ•°æ®",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [260, 300]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://clinicaltrials.gov/api/query/study_fields",
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "expr",
              "value": "AREA[StudyType]EXACT[\"Interventional\"] AND AREA[Phase]PHASE3"
            },
            {
              "name": "fields",
              "value": "NCTId,BriefTitle,Condition,InterventionName,PrimaryOutcomeMeasure,StudyFirstPostDate,CompletionDate,EnrollmentCount"
            },
            {
              "name": "min_rnk",
              "value": "1"
            },
            {
              "name": "max_rnk",
              "value": "20"
            },
            {
              "name": "fmt",
              "value": "json"
            }
          ]
        }
      },
      "name": "è·å–ä¸´åºŠè¯•éªŒæ•°æ®",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [480, 300]
    },
    {
      "parameters": {
        "functionCode": "// å¤„ç†å’Œæ¸…ç†ä¸´åºŠè¯•éªŒæ•°æ®\nconst items = $input.all();\nconst processedData = [];\n\nfor (const item of items) {\n  const studies = item.json.StudyFieldsResponse?.StudyFields || [];\n  \n  for (const study of studies) {\n    // æå–å…³é”®ä¿¡æ¯\n    const processedStudy = {\n      nctId: study.NCTId?.[0] || '',\n      title: study.BriefTitle?.[0] || '',\n      condition: study.Condition?.join('; ') || '',\n      intervention: study.InterventionName?.join('; ') || '',\n      primaryOutcome: study.PrimaryOutcomeMeasure?.[0] || '',\n      startDate: study.StudyFirstPostDate?.[0] || '',\n      completionDate: study.CompletionDate?.[0] || '',\n      enrollmentCount: parseInt(study.EnrollmentCount?.[0]) || 0,\n      collectedAt: new Date().toISOString(),\n      // æ·»åŠ æ•°æ®è´¨é‡æ ‡è®°\n      dataQuality: {\n        hasOutcome: !!study.PrimaryOutcomeMeasure?.[0],\n        hasEnrollment: !!study.EnrollmentCount?.[0],\n        isComplete: !!(study.CompletionDate?.[0])\n      }\n    };\n    \n    // åªä¿ç•™æœ‰ä¸»è¦ç»ˆç‚¹çš„ç ”ç©¶\n    if (processedStudy.dataQuality.hasOutcome) {\n      processedData.push({ json: processedStudy });\n    }\n  }\n}\n\nreturn processedData;"
      },
      "name": "æ•°æ®æ¸…ç†å’Œå¤„ç†",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [700, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{$json.enrollmentCount}}",
              "operation": "larger",
              "value2": 100
            }
          ]
        }
      },
      "name": "ç­›é€‰å¤§æ ·æœ¬ç ”ç©¶",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [920, 300]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": "your-google-sheet-id",
        "sheetName": "ä¸´åºŠè¯•éªŒæ•°æ®",
        "columns": {
          "mappingMode": "defineBelow",
          "values": {
            "NCT ID": "={{$json.nctId}}",
            "ç ”ç©¶æ ‡é¢˜": "={{$json.title}}",
            "ç–¾ç—…æ¡ä»¶": "={{$json.condition}}",
            "å¹²é¢„æªæ–½": "={{$json.intervention}}",
            "ä¸»è¦ç»ˆç‚¹": "={{$json.primaryOutcome}}",
            "å¼€å§‹æ—¥æœŸ": "={{$json.startDate}}",
            "å®Œæˆæ—¥æœŸ": "={{$json.completionDate}}",
            "å…¥ç»„äººæ•°": "={{$json.enrollmentCount}}",
            "æ”¶é›†æ—¶é—´": "={{$json.collectedAt}}"
          }
        },
        "options": {}
      },
      "name": "ä¿å­˜åˆ°Googleè¡¨æ ¼",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [1140, 300]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi",
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "db",
              "value": "pubmed"
            },
            {
              "name": "term",
              "value": "clinical trial[ptyp] AND \"last 7 days\"[PDat] AND (cancer OR oncology)"
            },
            {
              "name": "retmode",
              "value": "json"
            },
            {
              "name": "retmax",
              "value": "10"
            }
          ]
        }
      },
      "name": "è·å–PubMedæ–°è®ºæ–‡",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [480, 500]
    },
    {
      "parameters": {
        "functionCode": "// è·å–è®ºæ–‡è¯¦ç»†ä¿¡æ¯\nconst items = $input.all();\nconst pmids = [];\n\nfor (const item of items) {\n  const idList = item.json.esearchresult?.idlist || [];\n  pmids.push(...idList);\n}\n\nif (pmids.length === 0) {\n  return [{ json: { message: 'æ²¡æœ‰æ‰¾åˆ°æ–°è®ºæ–‡' } }];\n}\n\n// è¿”å›PMIDåˆ—è¡¨ç”¨äºä¸‹ä¸€æ­¥è·å–è¯¦ç»†ä¿¡æ¯\nreturn pmids.map(pmid => ({ json: { pmid } }));"
      },
      "name": "æå–è®ºæ–‡ID",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [700, 500]
    },
    {
      "parameters": {
        "requestMethod": "GET",
        "url": "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi",
        "options": {},
        "queryParametersUi": {
          "parameter": [
            {
              "name": "db",
              "value": "pubmed"
            },
            {
              "name": "id",
              "value": "={{$json.pmid}}"
            },
            {
              "name": "retmode",
              "value": "xml"
            }
          ]
        }
      },
      "name": "è·å–è®ºæ–‡è¯¦æƒ…",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [920, 500]
    },
    {
      "parameters": {
        "toEmail": "your-email@example.com",
        "subject": "EfficacyLens - æ¯å‘¨æ•°æ®æ”¶é›†æŠ¥å‘Š",
        "emailFormat": "html",
        "message": "=<h2>ğŸ“Š æœ¬å‘¨ä¸´åºŠè¯•éªŒæ•°æ®æ”¶é›†æŠ¥å‘Š</h2>\n\n<h3>ğŸ”¬ æ–°æ”¶é›†çš„è¯•éªŒæ•°æ®:</h3>\n<ul>\n{{#each $json}}\n<li><strong>{{this.title}}</strong> ({{this.nctId}})<br>\n   æ¡ä»¶: {{this.condition}}<br>\n   å…¥ç»„: {{this.enrollmentCount}} äºº</li>\n{{/each}}\n</ul>\n\n<h3>ğŸ“š æ–°å‘è¡¨è®ºæ–‡:</h3>\n<p>å‘ç° {{$json.length}} ç¯‡ç›¸å…³è®ºæ–‡</p>\n\n<h3>ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨:</h3>\n<ol>\n<li>å®¡æŸ¥æ”¶é›†çš„æ•°æ®è´¨é‡</li>\n<li>æ›´æ–°è§£æpipeline</li>\n<li>å¼€å§‹æ•°æ®åˆ†æ</li>\n</ol>\n\n<hr>\n<p><em>è‡ªåŠ¨ç”Ÿæˆäº: {{new Date().toLocaleString()}}</em></p>"
      },
      "name": "å‘é€æŠ¥å‘Šé‚®ä»¶",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [1360, 400]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.message}}",
              "operation": "notContains",
              "value2": "æ²¡æœ‰æ‰¾åˆ°"
            }
          ]
        }
      },
      "name": "æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1140, 500]
    }
  ],
  "connections": {
    "æ¯å‘¨ä¸€æ”¶é›†æ•°æ®": {
      "main": [
        [
          {
            "node": "è·å–ä¸´åºŠè¯•éªŒæ•°æ®",
            "type": "main",
            "index": 0
          },
          {
            "node": "è·å–PubMedæ–°è®ºæ–‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–ä¸´åºŠè¯•éªŒæ•°æ®": {
      "main": [
        [
          {
            "node": "æ•°æ®æ¸…ç†å’Œå¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ•°æ®æ¸…ç†å’Œå¤„ç†": {
      "main": [
        [
          {
            "node": "ç­›é€‰å¤§æ ·æœ¬ç ”ç©¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç­›é€‰å¤§æ ·æœ¬ç ”ç©¶": {
      "main": [
        [
          {
            "node": "ä¿å­˜åˆ°Googleè¡¨æ ¼",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ä¿å­˜åˆ°Googleè¡¨æ ¼": {
      "main": [
        [
          {
            "node": "å‘é€æŠ¥å‘Šé‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–PubMedæ–°è®ºæ–‡": {
      "main": [
        [
          {
            "node": "æå–è®ºæ–‡ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–è®ºæ–‡ID": {
      "main": [
        [
          {
            "node": "è·å–è®ºæ–‡è¯¦æƒ…",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è·å–è®ºæ–‡è¯¦æƒ…": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ•°æ®": {
      "main": [
        [
          {
            "node": "å‘é€æŠ¥å‘Šé‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "clinical-trials-collector"
} 